name: Build Release Bundle

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      scope_release:
        description: 'DGScope release tag (or "latest")'
        required: true
        default: 'latest'
  push:
    tags:
      - 'v*'

jobs:
  build-bundle:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build Profile Manager
        run: |
          dotnet publish src/DGScopeProfileManager/DGScopeProfileManager.csproj `
            -c Release `
            -r win-x64 `
            --self-contained `
            -p:PublishSingleFile=true `
            -o publish/ProfileManager
        shell: pwsh

      - name: Download DGScope Release
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the release info from yanjz124/scope using authenticated requests to avoid rate limits
          $releaseTag = "${{ github.event.inputs.scope_release }}"
          if (-not $releaseTag) { $releaseTag = "latest" }

          $headers = @{
            "Accept"       = "application/vnd.github+json"
            "Authorization" = "Bearer $env:GITHUB_TOKEN"
            "User-Agent"    = "github-actions-dgscope-profile-manager"
          }

          $releaseUrl = if ($releaseTag -eq 'latest') {
            "https://api.github.com/repos/yanjz124/scope/releases/latest"
          } else {
            "https://api.github.com/repos/yanjz124/scope/releases/tags/$releaseTag"
          }

          $release = (Invoke-WebRequest -Uri $releaseUrl -Headers $headers).Content | ConvertFrom-Json

          # Find the ZIP asset
          $zipAsset = $release.assets | Where-Object { $_.name -match "\.zip$" } | Select-Object -First 1
          
          if (-not $zipAsset) {
            Write-Error "No ZIP asset found in release"
            exit 1
          }
          
          Write-Host "Downloading $($zipAsset.name)..."
          Invoke-WebRequest -Uri $zipAsset.browser_download_url -Headers $headers -OutFile scope.zip
          
          Write-Host "Extracting DGScope..."
          Expand-Archive -Path scope.zip -DestinationPath scope-extract
          
          # Find scope folder and copy it
          $scopeFolder = Get-ChildItem scope-extract -Directory -Recurse -Filter "scope" | Select-Object -First 1
          if (-not $scopeFolder) {
            $scopeExe = Get-ChildItem scope-extract -File -Recurse -Filter "scope.exe" | Select-Object -First 1
            if ($scopeExe) {
              $scopeFolder = $scopeExe.Directory
            } else {
              Write-Error "Could not find scope.exe or scope folder"
              exit 1
            }
          }
          
          Copy-Item $scopeFolder.FullName -Destination publish/scope -Recurse
          Write-Host "DGScope copied to publish/scope"
          
          # Cleanup
          Remove-Item scope.zip -Force
          Remove-Item scope-extract -Recurse -Force
        shell: pwsh

      - name: Create Profiles Directory
        run: |
          New-Item -ItemType Directory -Path "publish/profiles" -Force | Out-Null
          Write-Host "Created profiles directory"
        shell: pwsh

      - name: Create README
        run: |
          Copy-Item "BUNDLE_README.md" -Destination "publish/README.md" -Force
          Write-Host "README.md created"
        shell: pwsh

      - name: Create ZIP Distributions
        run: |
          $releaseVersion = "${{ github.event.inputs.release_version }}"
          if (-not $releaseVersion) {
            $releaseVersion = "1.0.0"
          }

          # 1. Create Bundle ZIP (ProfileManager + DGScope + profiles folder)
          Write-Host "Creating Bundle ZIP..."
          New-Item -ItemType Directory -Path "release-temp-bundle" -Force | Out-Null
          New-Item -ItemType Directory -Path "release-temp-bundle/DGScope-Profile-Manager" -Force | Out-Null

          Copy-Item publish/* -Destination "release-temp-bundle/DGScope-Profile-Manager" -Recurse -Force

          $bundleZipName = "DGScope-Profile-Manager-v$releaseVersion-bundle.zip"
          Compress-Archive -Path "release-temp-bundle/DGScope-Profile-Manager" -DestinationPath $bundleZipName -Force
          Write-Host "Created $bundleZipName"

          # 2. Create ProfileManager-Only ZIP (just ProfileManager folder)
          Write-Host "Creating ProfileManager-Only ZIP..."
          New-Item -ItemType Directory -Path "release-temp-pm" -Force | Out-Null
          New-Item -ItemType Directory -Path "release-temp-pm/DGScope-Profile-Manager" -Force | Out-Null

          Copy-Item publish/ProfileManager -Destination "release-temp-pm/DGScope-Profile-Manager/ProfileManager" -Recurse -Force

          $pmZipName = "DGScope-Profile-Manager-v$releaseVersion.zip"
          Compress-Archive -Path "release-temp-pm/DGScope-Profile-Manager" -DestinationPath $pmZipName -Force
          Write-Host "Created $pmZipName"

          # Cleanup
          Remove-Item release-temp-bundle -Recurse -Force
          Remove-Item release-temp-pm -Recurse -Force
        shell: pwsh
        id: create_zip

      - name: Setup NSIS
        run: |
          Write-Host "Installing NSIS using winget..."
          winget install NSIS.NSIS -h --accept-source-agreements --accept-package-agreements
          Write-Host "NSIS installed"
        shell: pwsh

      - name: Build NSIS Installer
        run: |
          $releaseVersion = "${{ github.event.inputs.release_version }}"
          if (-not $releaseVersion) {
            $releaseVersion = "1.0.0"
          }
          
          # Copy published files to installer directory for NSIS to find them
          Write-Host "Preparing files for NSIS..."
          Copy-Item "publish/ProfileManager" -Destination "installer/ProfileManager" -Recurse -Force
          Copy-Item "publish/scope" -Destination "installer/scope" -Recurse -Force
          Copy-Item "publish/profiles" -Destination "installer/profiles" -Recurse -Force

          # Read template
          $nsiTemplate = Get-Content "installer/DGScopeProfileManager-Bundle.nsi" -Raw

          # Replace version
          $nsiScript = $nsiTemplate -replace "RELEASE_VERSION", $releaseVersion
          
          $nsiScript | Out-File -FilePath "installer/build-bundle.nsi" -Encoding ASCII
          
          # Build with NSIS
          Write-Host "Building NSIS installer..."
          & "C:\Program Files (x86)\NSIS\makensis.exe" "installer\build-bundle.nsi"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "NSIS build failed"
            exit 1
          }
          
          # Move installer to root with bundle suffix
          Move-Item "installer/DGScope-Profile-Manager-v$releaseVersion-Setup.exe" -Destination "DGScope-Profile-Manager-v$releaseVersion-bundle-Setup.exe" -Force

          Write-Host "NSIS bundle installer created"
        shell: pwsh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DGScope-Profile-Manager-Bundle
          path: |
            DGScope-Profile-Manager-*.zip
            DGScope-Profile-Manager-*-Setup.exe
          retention-days: 90

      - name: Upload Release Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            DGScope-Profile-Manager-*.zip
            DGScope-Profile-Manager-*-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
